<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TurboBot Web Controller</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'bounce-slow': 'bounce 2s infinite',
                        'spin-slow': 'spin 3s linear infinite',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .glass-dark {
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .terminal {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #00ff00;
        }

        .log-success { color: #10b981; }
        .log-error { color: #ef4444; }
        .log-warning { color: #f59e0b; }
        .log-info { color: #3b82f6; }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <!-- Header -->
        <div class="glass rounded-xl p-6 mb-6 text-center">
            <h1 class="text-4xl font-bold text-white mb-2">
                üöÄ TurboBot Web Controller
            </h1>
            <p class="text-blue-100 text-lg">
                Enhanced DeFi Automation Tool with Gas Management & V3 Support
            </p>
        </div>

        <!-- Status Bar -->
        <div class="glass rounded-xl p-6 mb-6">
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                <div class="flex items-center space-x-3 p-3 bg-white/10 rounded-lg">
                    <div id="connectionStatus" class="w-3 h-3 rounded-full bg-red-500 animate-pulse-slow"></div>
                    <span id="connectionText" class="text-white font-medium">Connecting...</span>
                </div>
                <div class="flex items-center space-x-3 p-3 bg-white/10 rounded-lg">
                    <span class="text-2xl">‚õΩ</span>
                    <div>
                        <div class="text-white font-medium" id="gasPrice">-- Gwei</div>
                        <div class="text-blue-200 text-xs">Gas Price</div>
                    </div>
                </div>
                <div class="flex items-center space-x-3 p-3 bg-white/10 rounded-lg">
                    <span class="text-2xl">üí∞</span>
                    <div>
                        <div class="text-white font-medium" id="ethPrice">$--</div>
                        <div class="text-blue-200 text-xs">ETH Price</div>
                    </div>
                </div>
                <div class="flex items-center space-x-3 p-3 bg-white/10 rounded-lg">
                    <span class="text-2xl">üëõ</span>
                    <div>
                        <div class="text-white font-medium" id="totalWallets">--</div>
                        <div class="text-blue-200 text-xs">Wallets</div>
                    </div>
                </div>
                <div class="flex items-center space-x-3 p-3 bg-white/10 rounded-lg">
                    <span class="text-2xl">ü™ô</span>
                    <div>
                        <div class="text-white font-medium" id="totalTokens">--</div>
                        <div class="text-blue-200 text-xs">Tokens</div>
                    </div>
                </div>
                <div class="flex items-center space-x-3 p-3 bg-white/10 rounded-lg">
                    <span class="text-2xl">‚ö°</span>
                    <div>
                        <div class="text-white font-medium" id="activeOps">0</div>
                        <div class="text-blue-200 text-xs">Active</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
            <!-- Main Wallet Card -->
            <div class="glass rounded-xl p-6 card-hover">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-white font-semibold text-lg">üíº Main Wallet</h3>
                    <button onclick="refreshMainWallet()" class="text-blue-300 hover:text-blue-100 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                    </button>
                </div>
                <div id="mainWalletContent" class="space-y-3">
                    <div class="text-blue-200 text-sm">Loading...</div>
                </div>
            </div>

            <!-- Wallet Stats Card -->
            <div class="glass rounded-xl p-6 card-hover">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-white font-semibold text-lg">üìä Wallet Stats</h3>
                    <button onclick="refreshWalletStats()" class="text-green-300 hover:text-green-100 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                    </button>
                </div>
                <div id="walletStatsContent" class="space-y-3">
                    <div class="text-green-200 text-sm">Loading...</div>
                </div>
            </div>

            <!-- Token Database Card -->
            <div class="glass rounded-xl p-6 card-hover">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-white font-semibold text-lg">ü™ô Token Database</h3>
                    <button onclick="showTokenManager()" class="text-yellow-300 hover:text-yellow-100 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                    </button>
                </div>
                <div id="tokenStatsContent" class="space-y-3">
                    <div class="text-yellow-200 text-sm">Loading...</div>
                </div>
            </div>

            <!-- Gas Tracker Card -->
            <div class="glass rounded-xl p-6 card-hover">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-white font-semibold text-lg">‚õΩ Gas Tracker</h3>
                    <button onclick="refreshGasData()" class="text-red-300 hover:text-red-100 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                    </button>
                </div>
                <div id="gasStatsContent" class="space-y-3">
                    <div class="text-red-200 text-sm">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Gas Calculator -->
        <div class="glass rounded-xl p-6 mb-6">
            <h3 class="text-white font-semibold text-xl mb-6 flex items-center">
                ‚õΩ Gas Cost Calculator
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-white/10 rounded-lg p-4">
                    <h4 class="text-blue-300 font-medium mb-2">Current Gas</h4>
                    <div class="text-2xl font-bold text-white" id="currentGasGwei">-- Gwei</div>
                    <div class="text-blue-200 text-sm">Network average</div>
                </div>
                <div class="bg-white/10 rounded-lg p-4">
                    <h4 class="text-green-300 font-medium mb-2">1000 Transfers</h4>
                    <div class="text-2xl font-bold text-white" id="cost1000Tx">$--</div>
                    <div class="text-green-200 text-sm">Simple transfers</div>
                </div>
                <div class="bg-white/10 rounded-lg p-4">
                    <h4 class="text-yellow-300 font-medium mb-2">1000 Swaps</h4>
                    <div class="text-2xl font-bold text-white" id="cost1000Swaps">$--</div>
                    <div class="text-yellow-200 text-sm">~200k gas each</div>
                </div>
                <div class="bg-white/10 rounded-lg p-4">
                    <h4 class="text-red-300 font-medium mb-2">Network Status</h4>
                    <div class="text-2xl font-bold text-white" id="networkStatus">--</div>
                    <div class="text-red-200 text-sm">Congestion level</div>
                </div>
            </div>
        </div>

        <!-- Emergency Controls -->
        <div class="bg-red-900/30 border border-red-500/50 rounded-xl p-6 mb-6">
            <h3 class="text-red-400 font-semibold text-lg mb-4 flex items-center">
                üö® Emergency Controls
            </h3>
            <div class="bg-red-500/20 border border-red-500/30 rounded-lg p-4 mb-4">
                <div class="flex items-center space-x-2 text-red-300">
                    <span>‚ö†Ô∏è</span>
                    <span>Use this button to immediately terminate all running processes and automation.</span>
                </div>
            </div>
            <button onclick="killAllProcesses()" 
                    class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-6 rounded-lg transition-all duration-300 transform hover:scale-105 hover:shadow-lg">
                üíÄ KILL ALL PROCESSES
            </button>
        </div>

        <!-- Main Controls Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Wallet Management -->
            <div class="glass rounded-xl p-6">
                <h3 class="text-white font-semibold text-xl mb-6 flex items-center">
                    üëõ Wallet Management
                </h3>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-blue-200 text-sm font-medium mb-2">Create Count</label>
                            <input type="number" id="createCount" placeholder="100" value="100"
                                   class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-blue-200 text-sm font-medium mb-2">Target Total</label>
                            <input type="number" id="targetCount" placeholder="1000"
                                   class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                        <button onclick="createWallets()" 
                                class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                            ‚ûï Create Wallets
                        </button>
                        <button onclick="targetWallets()" 
                                class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                            üéØ Create to Target
                        </button>
                        <button onclick="checkWallets()" 
                                class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                            üìä Check Wallets
                        </button>
                    </div>
                </div>
            </div>

            <!-- Token Management -->
            <div class="glass rounded-xl p-6">
                <h3 class="text-white font-semibold text-xl mb-6 flex items-center">
                    ü™ô Token Management
                </h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-yellow-200 text-sm font-medium mb-2">Token Addresses (comma-separated)</label>
                        <div class="relative">
                            <textarea id="tokenAddresses" placeholder="0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913,0x..."
                                      class="w-full px-3 py-2 pr-10 bg-white/10 border border-white/20 rounded-lg text-white placeholder-yellow-300 focus:outline-none focus:ring-2 focus:ring-yellow-500 resize-none"
                                      rows="3"></textarea>
                            <button onclick="openTokenSelector('tokenAddresses', true)" 
                                    class="absolute right-2 top-2 text-yellow-300 hover:text-yellow-100 transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <button onclick="addTokens()" 
                                class="bg-yellow-600 hover:bg-yellow-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                            ‚ûï Add Tokens
                        </button>
                        <button onclick="viewTokenDatabase()" 
                                class="bg-orange-600 hover:bg-orange-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                            üìö View Database
                        </button>
                    </div>
                </div>
            </div>

            <!-- Trading Operations -->
            <div class="glass rounded-xl p-6">
                <h3 class="text-white font-semibold text-xl mb-6 flex items-center">
                    ‚ö° Trading Operations
                </h3>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-purple-200 text-sm font-medium mb-2">Single Token</label>
                            <div class="relative">
                                <input type="text" id="singleToken" placeholder="0x..."
                                       class="w-full px-3 py-2 pr-10 bg-white/10 border border-white/20 rounded-lg text-white placeholder-purple-300 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <button onclick="openTokenSelector('singleToken')" 
                                        class="absolute right-2 top-1/2 transform -translate-y-1/2 text-purple-300 hover:text-purple-100 transition-colors">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-purple-200 text-sm font-medium mb-2">Batch Size</label>
                            <input type="number" id="tradeBatchSize" placeholder="50" value="50"
                                   class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-purple-300 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-purple-200 text-sm font-medium mb-2">Start Index</label>
                            <input type="number" id="startIndex" placeholder="0" value="0"
                                   class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-purple-300 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block text-purple-200 text-sm font-medium mb-2">End Index</label>
                            <input type="number" id="endIndex" placeholder="100" value="100"
                                   class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-purple-300 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="startSwapBatch()" 
                                class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                            üîÑ V2 Swap Batch
                        </button>
                        <button onclick="startV3SwapBatch()" 
                                class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                            ‚ö° V3 Swap Batch
                        </button>
                    </div>
                </div>
            </div>

            <!-- Volume Generation -->
            <div class="glass rounded-xl p-6">
                <h3 class="text-white font-semibold text-xl mb-6 flex items-center">
                    üî• Volume Generation
                </h3>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-orange-200 text-sm font-medium mb-2">Volume Token</label>
                            <div class="relative">
                                <input type="text" id="volumeToken" placeholder="0x..."
                                       class="w-full px-3 py-2 pr-10 bg-white/10 border border-white/20 rounded-lg text-white placeholder-orange-300 focus:outline-none focus:ring-2 focus:ring-orange-500">
                                <button onclick="openTokenSelector('volumeToken')" 
                                        class="absolute right-2 top-1/2 transform -translate-y-1/2 text-orange-300 hover:text-orange-100 transition-colors">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-orange-200 text-sm font-medium mb-2">TX Delay (ms)</label>
                            <input type="number" id="volumeTxDelay" placeholder="150" value="150"
                                   class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-orange-300 focus:outline-none focus:ring-2 focus:ring-orange-500">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-orange-200 text-sm font-medium mb-2">Cycle Delay (ms)</label>
                            <input type="number" id="volumeCycleDelay" placeholder="3000" value="3000"
                                   class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-orange-300 focus:outline-none focus:ring-2 focus:ring-orange-500">
                        </div>
                        <div>
                            <label class="block text-orange-200 text-sm font-medium mb-2">Funding Amount</label>
                            <input type="number" id="fundingAmount" step="0.000001" placeholder="0.00001" value="0.00001"
                                   class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-orange-300 focus:outline-none focus:ring-2 focus:ring-orange-500">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                        <button onclick="startVolumeV2()" 
                                class="bg-orange-600 hover:bg-orange-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                            üìà V2 Volume
                        </button>
                        <button onclick="startVolumeV3()" 
                                class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                            üìà V3 Volume
                        </button>
                        <button onclick="startVolumeV3Fresh()" 
                                class="bg-pink-600 hover:bg-pink-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                            üÜï V3 Fresh
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Panel -->
        <div class="glass rounded-xl p-6 mb-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-white font-semibold text-xl">üìä Live Statistics</h3>
                <button onclick="refreshAllStats()" 
                        class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                    üîÑ Refresh All
                </button>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                <div class="bg-white/10 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-green-400" id="successfulOps">0</div>
                    <div class="text-green-200 text-sm">Successful</div>
                </div>
                <div class="bg-white/10 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-red-400" id="failedOps">0</div>
                    <div class="text-red-200 text-sm">Failed</div>
                </div>
                <div class="bg-white/10 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-blue-400" id="successRate">0%</div>
                    <div class="text-blue-200 text-sm">Success Rate</div>
                </div>
                <div class="bg-white/10 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-purple-400" id="totalGasUsed">0.000</div>
                    <div class="text-purple-200 text-sm">Gas Used (ETH)</div>
                </div>
                <div class="bg-white/10 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-yellow-400" id="fundedWallets">0</div>
                    <div class="text-yellow-200 text-sm">Funded Wallets</div>
                </div>
                <div class="bg-white/10 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-indigo-400" id="totalBalance">0.000</div>
                    <div class="text-indigo-200 text-sm">Total Balance</div>
                </div>
            </div>
        </div>

        <!-- Terminal Output -->
        <div class="glass rounded-xl p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-white font-semibold text-xl">üñ•Ô∏è Terminal Output</h3>
                <div class="flex space-x-2">
                    <button onclick="clearTerminal()" 
                            class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg transition-colors text-sm">
                        üóëÔ∏è Clear
                    </button>
                    <button onclick="exportLogs()" 
                            class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors text-sm">
                        üì• Export
                    </button>
                </div>
            </div>
            <div id="terminal" class="terminal rounded-lg p-4 h-80 overflow-y-auto text-sm">
                <div class="log-entry log-info">TurboBot Web Controller v3.0 - Ready</div>
                <div class="log-entry">Enhanced with real-time API integration</div>
                <div class="log-entry">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</div>
            </div>
        </div>
    </div>

    <!-- Token Selector Modal -->
    <div id="tokenSelectorModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="glass rounded-xl p-6 max-w-4xl w-full max-h-[80vh] overflow-hidden">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-white font-semibold text-xl">ü™ô Select Token(s)</h3>
                <button onclick="hideTokenSelector()" class="text-white hover:text-red-300 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <div id="applytokenselected" class="flex justify-between items-center my-10 pt-4 border-t border-white/20 hidden">
                <div class="text-gray-300 text-sm">
                    <span id="selectedCount">0</span> token(s) selected
                </div>
                <div class="flex space-x-3">
                    <button onclick="hideTokenSelector()" 
                            class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                        Cancel
                    </button>
                    <button onclick="applyTokenSelection()" 
                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                        Apply Selection
                    </button>
                </div>
            </div>
            
            <!-- Search and Filter -->
            <div class="mb-4 space-y-4">
                <div class="flex space-x-4">
                    <div class="flex-1">
                        <input type="text" id="tokenSearch" placeholder="Search by symbol, name, or address..."
                               class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button onclick="clearTokenSearch()" 
                            class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                        Clear
                    </button>
                </div>
                
                <!-- Default tokens quick select -->
                <div class="flex flex-wrap gap-2">
                    <span class="text-gray-300 text-sm">Quick select:</span>
                    <button onclick="selectDefaultTokens('V2')" 
                            class="px-3 py-1 bg-blue-600/50 hover:bg-blue-600 text-white text-sm rounded-lg transition-colors">
                        Default V2 Tokens
                    </button>
                    <button onclick="selectDefaultTokens('V3')" 
                            class="px-3 py-1 bg-purple-600/50 hover:bg-purple-600 text-white text-sm rounded-lg transition-colors">
                        Default V3 Tokens
                    </button>
                </div>
            </div>

            <!-- Token List -->
            <div id="tokenSelectorContent" class="overflow-y-auto max-h-96 space-y-2">
                <!-- Token list will be populated here -->
            </div>
            
            <!-- Selected tokens display -->
            <div id="selectedTokensDisplay" class="mt-4 hidden">
                <div class="text-white font-medium mb-2">Selected Tokens:</div>
                <div id="selectedTokensList" class="flex flex-wrap gap-2 mb-4">
                    <!-- Selected tokens will appear here -->
                </div>
            </div>
            
            <!-- Action buttons -->
            
        </div>
    </div>

    <!-- Token Manager Modal -->
    <div id="tokenModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-40 flex items-center justify-center p-4">
        <div class="glass rounded-xl p-6 max-w-4xl w-full max-h-[80vh] overflow-hidden">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-white font-semibold text-xl">ü™ô Token Database Manager</h3>
                <button onclick="hideTokenManager()" class="text-white hover:text-red-300 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="tokenModalContent" class="overflow-y-auto max-h-96">
                <!-- Token list will be populated here -->
            </div>
    <!-- Loading Overlay -->
    <div id="loading" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-30 flex items-center justify-center">
        <div class="bg-white/10 rounded-xl p-8 flex items-center space-x-4">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white"></div>
            <span class="text-white font-medium">Processing...</span>
        </div>
    </div>
    <script>
// Global state management
let automationProcesses = new Set();
let commandHistory = [];
let wsConnection = null;
let activeCommands = new Set();
let stats = {
    successfulOps: 0,
    failedOps: 0,
    totalGasUsed: 0,
    totalWallets: 0,
    fundedWallets: 0,
    totalBalance: 0
};

// Token selector state
let currentTargetInput = null;
let isMultiSelect = false;
let selectedTokens = [];
let allTokensData = [];
let filteredTokens = [];

// Token selector functions
async function openTokenSelector(targetInputId, multiSelect = false) {
    currentTargetInput = targetInputId;
    isMultiSelect = multiSelect;
    selectedTokens = [];
    
    // Load tokens if not already loaded
    if (!allTokensData.length) {
        await loadTokensForSelector();
    }
    
    // If multiSelect, parse existing tokens from input
    if (multiSelect) {
        const currentValue = document.getElementById(targetInputId).value;
        if (currentValue.trim()) {
            selectedTokens = currentValue.split(',').map(addr => addr.trim()).filter(addr => addr);
        }
    }
    
    filteredTokens = [...allTokensData];
    displayTokenSelector();
    updateSelectedTokensDisplay();
    document.getElementById('tokenSelectorModal').classList.remove('hidden');
}

function hideTokenSelector() {
    document.getElementById('tokenSelectorModal').classList.add('hidden');
    currentTargetInput = null;
    isMultiSelect = false;
    selectedTokens = [];
    document.getElementById('tokenSearch').value = '';
}

async function loadTokensForSelector() {
    try {
        showLoading(true);
        
        // Load from database
        const response = await fetch('/api/tokens');
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                allTokensData = data.tokens;
            }
        }
        
        // Also load default tokens
        const defaultResponse = await fetch('/api/tokens/defaults');
        if (defaultResponse.ok) {
            const defaultData = await defaultResponse.json();
            if (defaultData.success) {
                // Add default tokens that might not be in database
                const defaultTokens = [
                    ...defaultData.v2Tokens.map(addr => ({ address: addr, symbol: 'V2 Token', isDefault: true, type: 'V2' })),
                    ...defaultData.v3Tokens.map(addr => ({ address: addr, symbol: 'V3 Token', isDefault: true, type: 'V3' }))
                ];
                
                // Add defaults that aren't already in the database
                defaultTokens.forEach(defaultToken => {
                    if (!allTokensData.find(token => token.address.toLowerCase() === defaultToken.address.toLowerCase())) {
                        allTokensData.push(defaultToken);
                    }
                });
            }
        }
        
        logToTerminal(`üìö Loaded ${allTokensData.length} tokens for selection`, 'info');
        
    } catch (error) {
        logToTerminal(`‚ùå Failed to load tokens: ${error.message}`, 'error');
        allTokensData = [];
    } finally {
        showLoading(false);
    }
}

function displayTokenSelector() {
    const content = document.getElementById('tokenSelectorContent');
    
    if (!filteredTokens.length) {
        content.innerHTML = `
            <div class="text-center py-8">
                <div class="text-gray-400 text-lg mb-4">No tokens found</div>
                <div class="text-gray-500">Try adjusting your search criteria</div>
            </div>
        `;
        return;
    }
    
    content.innerHTML = filteredTokens.map(token => {
        const isSelected = selectedTokens.includes(token.address);
        const displayName = token.name || token.symbol || 'Unknown Token';
        const displaySymbol = token.symbol || 'N/A';
        
        return `
            <div class="flex items-center justify-between p-3 bg-white/10 hover:bg-white/20 rounded-lg cursor-pointer transition-colors ${isSelected ? 'ring-2 ring-blue-500 bg-blue-500/20' : ''}"
                 onclick="toggleTokenSelection('${token.address}')">
                <div class="flex-1 min-w-0">
                    <div class="flex items-center space-x-3">
                        <div class="flex-shrink-0">
                            ${isMultiSelect ? `
                                <div class="w-5 h-5 rounded border-2 ${isSelected ? 'bg-blue-500 border-blue-500' : 'border-gray-400'} flex items-center justify-center">
                                    ${isSelected ? '<svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>' : ''}
                                </div>
                            ` : `
                                <div class="w-5 h-5 rounded-full ${isSelected ? 'bg-blue-500' : 'bg-gray-400'}"></div>
                            `}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center space-x-2 mb-1">
                                <div class="text-white font-medium">${displaySymbol}</div>
                                ${token.decimals ? `<div class="text-gray-400 text-xs">${token.decimals} decimals</div>` : ''}
                                ${token.isDefault ? `<div class="px-2 py-1 bg-blue-500/30 text-blue-300 text-xs rounded">${token.type || 'Default'}</div>` : ''}
                            </div>
                            <div class="text-gray-300 text-sm mb-1">${displayName}</div>
                            <div class="text-gray-400 text-xs font-mono break-all">${token.address}</div>
                        </div>
                    </div>
                </div>
                <div class="flex-shrink-0 ml-3">
                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </div>
            </div>
        `;
    }).join('');
}

function toggleTokenSelection(address) {
    if (isMultiSelect) {
        const index = selectedTokens.indexOf(address);
        if (index > -1) {
            selectedTokens.splice(index, 1);
        } else {
            selectedTokens.push(address);
        }
        displayTokenSelector();
        updateSelectedTokensDisplay();
    } else {
        selectedTokens = [address];
        displayTokenSelector();
        updateSelectedTokensDisplay();
    }
}

function updateSelectedTokensDisplay() {
    const countElement = document.getElementById('selectedCount');
    const displayElement = document.getElementById('selectedTokensDisplay');
    const listElement = document.getElementById('selectedTokensList');
    const applyButton = document.getElementById('applytokenselected');
    
    countElement.textContent = selectedTokens.length;
    
    if (selectedTokens.length > 0) {
        displayElement.classList.remove('hidden');
        applyButton.classList.remove('hidden');
        
        listElement.innerHTML = selectedTokens.map(address => {
            const token = allTokensData.find(t => t.address === address);
            const displayText = token ? (token.symbol || token.name || address.slice(0, 8) + '...') : address.slice(0, 8) + '...';
            
            return `
                <div class="flex items-center space-x-2 px-3 py-1 bg-blue-500/30 text-blue-200 rounded-lg">
                    <span class="text-sm">${displayText}dd</span>
                    <button onclick="removeSelectedToken('${address}')" class="text-blue-300 hover:text-white">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `;
        }).join('');
    } else {
        displayElement.classList.add('hidden');
        applyButton.classList.add('hidden');
    }
    
}

function removeSelectedToken(address) {
    const index = selectedTokens.indexOf(address);
    if (index > -1) {
        selectedTokens.splice(index, 1);
        displayTokenSelector();
        updateSelectedTokensDisplay();
    }
}

function applyTokenSelection() {
    if (!currentTargetInput || selectedTokens.length === 0) {
        hideTokenSelector();
        return;
    }
    
    const targetElement = document.getElementById(currentTargetInput);
    
    if (isMultiSelect) {
        targetElement.value = selectedTokens.join(',');
        logToTerminal(`‚úÖ Selected ${selectedTokens.length} tokens`, 'success');
    } else {
        targetElement.value = selectedTokens[0];
        const token = allTokensData.find(t => t.address === selectedTokens[0]);
        const tokenName = token ? (token.symbol || token.name) : 'Token';
        logToTerminal(`‚úÖ Selected token: ${tokenName}`, 'success');
    }
    
    hideTokenSelector();
}

async function selectDefaultTokens(type) {
    try {
        const response = await fetch('/api/tokens/defaults');
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                const defaultAddresses = type === 'V2' ? data.v2Tokens : data.v3Tokens;
                
                if (isMultiSelect) {
                    // Add to current selection (avoid duplicates)
                    defaultAddresses.forEach(address => {
                        if (!selectedTokens.includes(address)) {
                            selectedTokens.push(address);
                        }
                    });
                } else {
                    selectedTokens = defaultAddresses.slice(0, 1); // Only first token for single select
                }
                
                displayTokenSelector();
                updateSelectedTokensDisplay();
                logToTerminal(`‚úÖ Added ${type} default tokens`, 'success');
            }
        }
    } catch (error) {
        logToTerminal(`‚ùå Failed to load default tokens: ${error.message}`, 'error');
    }
}

function clearTokenSearch() {
    document.getElementById('tokenSearch').value = '';
    filteredTokens = [...allTokensData];
    displayTokenSelector();
}

// Search functionality
document.addEventListener('DOMContentLoaded', function() {
    // Add search event listener when DOM is ready
    setTimeout(() => {
        const searchInput = document.getElementById('tokenSearch');
        if (searchInput) {
            searchInput.addEventListener('input', function(e) {
                const query = e.target.value.toLowerCase().trim();
                
                if (!query) {
                    filteredTokens = [...allTokensData];
                } else {
                    filteredTokens = allTokensData.filter(token => {
                        return (
                            token.address.toLowerCase().includes(query) ||
                            (token.symbol && token.symbol.toLowerCase().includes(query)) ||
                            (token.name && token.name.toLowerCase().includes(query))
                        );
                    });
                }
                
                displayTokenSelector();
            });
        }
    }, 1000);
});

// Initialize the application
function initializeApp() {
    logToTerminal('üöÄ TurboBot Web Controller v3.0 initialized', 'success');
    logToTerminal('üîÑ Establishing real-time connection...', 'info');
    
    // Initialize WebSocket connection
    initializeWebSocket();
    
    // Load initial data
    loadDashboardData();
    
    // Start periodic updates
    setInterval(updateDashboard, 30000); // Update every 30 seconds
    setInterval(updateGasData, 60000); // Update gas data every minute
    
    logToTerminal('üí° Enhanced with real-time API integration', 'info');
    logToTerminal('üö® Emergency controls and token management available', 'info');
    logToTerminal('‚õΩ Live gas tracking and cost calculator active', 'info');
}

// WebSocket connection management
function initializeWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}`;
    
    try {
        wsConnection = new WebSocket(wsUrl);
        
        wsConnection.onopen = function(event) {
            logToTerminal('üîó Real-time connection established', 'success');
            updateConnectionStatus(true);
        };
        
        wsConnection.onmessage = function(event) {
            try {
                const message = JSON.parse(event.data);
                handleWebSocketMessage(message);
            } catch (error) {
                console.error('Error parsing WebSocket message:', error);
            }
        };
        
        wsConnection.onclose = function(event) {
            logToTerminal('‚ùå Real-time connection lost', 'error');
            updateConnectionStatus(false);
            
            setTimeout(() => {
                logToTerminal('üîÑ Attempting to reconnect...', 'info');
                initializeWebSocket();
            }, 3000);
        };
        
        wsConnection.onerror = function(error) {
            logToTerminal('‚ö†Ô∏è Connection error occurred', 'warning');
            updateConnectionStatus(false);
        };
        
    } catch (error) {
        logToTerminal('‚ùå Failed to establish WebSocket connection', 'error');
        updateConnectionStatus(false);
    }
}

// Handle WebSocket messages
function handleWebSocketMessage(message) {
    switch (message.type) {
        case 'connection':
            logToTerminal('‚úÖ Connected to TurboBot backend', 'success');
            break;
            
        case 'output':
            const cleanOutput = message.data.replace(/\n$/, '');
            if (cleanOutput.trim()) {
                logToTerminal(cleanOutput, 'info');
                parseOutputForStats(cleanOutput);
            }
            break;
            
        case 'error':
            logToTerminal(message.data, 'error');
            break;
            
        case 'complete':
            if (message.processId) {
                activeCommands.delete(message.processId);
            }
            
            if (message.success) {
                logToTerminal(`‚úÖ Command completed: ${message.command}`, 'success');
                stats.successfulOps++;
            } else {
                logToTerminal(`‚ùå Command failed: ${message.command} (exit code: ${message.exitCode})`, 'error');
                stats.failedOps++;
            }
            updateStats();
            // Refresh dashboard data after operations
            setTimeout(loadDashboardData, 2000);
            break;
            
        case 'process_error':
            activeCommands.clear();
            logToTerminal(`üí• Process error: ${message.error}`, 'error');
            stats.failedOps++;
            updateStats();
            break;
            
        case 'stopped':
            logToTerminal(`üõë Process stopped: ${message.command}`, 'warning');
            activeCommands.delete(message.processId);
            break;
            
        case 'all_stopped':
            logToTerminal(`üõë All processes stopped (${message.stoppedProcesses?.length || 0} processes)`, 'warning');
            automationProcesses.clear();
            activeCommands.clear();
            updateStats();
            break;
            
        case 'long_running':
            logToTerminal(`‚è≥ ${message.message}`, 'info');
            break;
    }
}

// API Functions
async function loadDashboardData() {
    try {
        const response = await fetch('/api/dashboard');
        if (response.ok) {
            dashboardData = await response.json();
            if (dashboardData?.success) {
                console.log(dashboardData?.dashboard)
                updateDashboardUI(dashboardData?.dashboard);
                updateGasUI(dashboardData?.gasData);
                logToTerminal('üìä Dashboard data loaded', 'success');
            }
        }
    } catch (error) {
        logToTerminal(`‚ùå Failed to load dashboard data: ${error?.message}`, 'error');
    }
}

async function refreshMainWallet() {
    try {
        const response = await fetch('/api/wallet/main');
        if (response.ok) {
            const data = await response.json();
            updateMainWalletCard(data);
        }
    } catch (error) {
        logToTerminal(`‚ùå Failed to refresh main wallet: ${error.message}`, 'error');
    }
}

async function refreshWalletStats() {
    try {
        const response = await fetch('/api/wallets/stats');
        if (response.ok) {
            const data = await response.json();
            updateWalletStatsCard(data);
        }
    } catch (error) {
        logToTerminal(`‚ùå Failed to refresh wallet stats: ${error.message}`, 'error');
    }
}

async function refreshGasData() {
    try {
        const response = await fetch('/api/gas-prices');
        if (response.ok) {
            gasData = await response.json();
            updateGasUI(gasData);
        }
    } catch (error) {
        logToTerminal(`‚ùå Failed to refresh gas data: ${error.message}`, 'error');
    }
}

async function addTokens() {
    const addresses = document.getElementById('tokenAddresses').value;
    if (!addresses.trim()) {
        logToTerminal('‚ùå Please enter token addresses', 'error');
        return;
    }

    const addressList = addresses.split(',').map(addr => addr.trim()).filter(addr => addr);
    
    try {
        showLoading(true);
        logToTerminal(`ü™ô Adding ${addressList.length} tokens...`, 'info');
        
        const response = await fetch('/api/tokens/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ addresses: addressList })
        });
        
        const result = await response.json();
        
        if (result.success) {
            logToTerminal(`‚úÖ Added ${result.added} tokens, ${result.failed} failed`, 'success');
            document.getElementById('tokenAddresses').value = '';
            await loadTokenData();
        } else {
            logToTerminal(`‚ùå Failed to add tokens: ${result.error}`, 'error');
        }
    } catch (error) {
        logToTerminal(`‚ùå Error adding tokens: ${error.message}`, 'error');
    } finally {
        showLoading(false);
    }
}

async function loadTokenData() {
    try {
        const response = await fetch('/api/tokens');
        if (response.ok) {
            tokenData = await response.json();
            updateTokenStatsCard(tokenData);
        }
    } catch (error) {
        console.error('Failed to load token data:', error);
    }
}

// UI Update Functions
function updateDashboardUI(dashboard) {
    if (!dashboard?.success) return;
    
    
    // Update status bar
    document.getElementById('totalWallets').textContent = dashboard.wallets.total || '0';
    document.getElementById('totalTokens').textContent = dashboard.tokens.total || '0';
    document.getElementById('activeOps').textContent = dashboard.system.activeProcesses || '0';
    
    if (dashboard.gas) {
        document.getElementById('gasPrice').textContent = `${dashboard.gas.currentGwei?.toFixed(1) || '--'} Gwei`;
        document.getElementById('ethPrice').textContent = `${dashboard.gas.ethPrice?.toFixed(0) || '--'}`;
    }
    
    // Update individual cards
    updateMainWalletCard({ success: true, ...dashboard.mainWallet });
    updateWalletStatsCard({ success: true, totalWallets: dashboard.wallets.total });
    updateTokenStatsCard();
    updateGasStatsCard(dashboard.gas);
}

function updateMainWalletCard(data) {
    const content = document.getElementById('mainWalletContent');
    
    if (!data.success || data.error) {
        content.innerHTML = `
            <div class="text-red-300 text-sm">${data.error || 'Failed to load'}</div>
        `;
        return;
    }
    
    content.innerHTML = `
        <div class="space-y-2">
            <div class="text-blue-200 text-xs">Address</div>
            <div class="text-white text-sm font-mono break-all">${data.address || 'Not configured'}</div>
            <div class="flex justify-between items-center">
                <div class="text-blue-200 text-xs">Balance</div>
                <div class="text-white font-semibold">${data.balance || '0'} ETH</div>
            </div>
            ${data.canFund !== undefined ? `
                <div class="flex items-center space-x-2">
                    <div class="w-2 h-2 rounded-full ${data.canFund ? 'bg-green-400' : 'bg-red-400'}"></div>
                    <div class="text-xs ${data.canFund ? 'text-green-300' : 'text-red-300'}">
                        ${data.canFund ? 'Can fund operations' : 'Insufficient balance'}
                    </div>
                </div>
            ` : ''}
        </div>
    `;
}

function updateWalletStatsCard(data) {
    const content = document.getElementById('walletStatsContent');
    
    if (!data.success) {
        content.innerHTML = `<div class="text-red-300 text-sm">Failed to load wallet stats</div>`;
        return;
    }
    
    content.innerHTML = `
        <div class="space-y-2">
            <div class="flex justify-between items-center">
                <div class="text-green-200 text-xs">Total Wallets</div>
                <div class="text-white font-semibold">${data.totalWallets || 0}</div>
            </div>
            ${data.summary ? `
                <div class="flex justify-between items-center">
                    <div class="text-green-200 text-xs">Funded</div>
                    <div class="text-white font-semibold">${data.summary.fundedWallets || 0}</div>
                </div>
                <div class="flex justify-between items-center">
                    <div class="text-green-200 text-xs">Avg Balance</div>
                    <div class="text-white font-semibold">${parseFloat(data.summary.avgBalance || 0).toFixed(6)} ETH</div>
                </div>
                <div class="flex justify-between items-center">
                    <div class="text-green-200 text-xs">Estimated Total</div>
                    <div class="text-white font-semibold">${data.summary.estimatedTotalValue?.toFixed(6) || '0'} ETH</div>
                </div>
            ` : ''}
        </div>
    `;
}

function updateTokenStatsCard(tokenData) {
    const content = document.getElementById('tokenStatsContent');
    
    if (!tokenData.success) {
        content.innerHTML = `<div class="text-yellow-300 text-sm">Loading tokens...</div>`;
        return;
    }
    
    content.innerHTML = `
        <div class="space-y-2">
            <div class="flex justify-between items-center">
                <div class="text-yellow-200 text-xs">Total Tokens</div>
                <div class="text-white font-semibold">${tokenData.totalTokens || 0}</div>
            </div>
            <div class="flex justify-between items-center">
                <div class="text-yellow-200 text-xs">Unique Symbols</div>
                <div class="text-white font-semibold">${tokenData.uniqueSymbols || 0}</div>
            </div>
            ${tokenData.recentlyAdded && tokenData.recentlyAdded.length > 0 ? `
                <div class="text-yellow-200 text-xs">Recently Added</div>
                <div class="space-y-1">
                    ${tokenData.recentlyAdded.slice(0, 3).map(token => `
                        <div class="text-white text-xs font-mono">${token.symbol}</div>
                    `).join('')}
                </div>
            ` : ''}
        </div>
    `;
}

function updateGasStatsCard(gasInfo) {
    const content = document.getElementById('gasStatsContent');
    
    if (!gasInfo) {
        content.innerHTML = `<div class="text-red-300 text-sm">Loading gas data...</div>`;
        return;
    }
    
    content.innerHTML = `
        <div class="space-y-2">
            <div class="flex justify-between items-center">
                <div class="text-red-200 text-xs">Current</div>
                <div class="text-white font-semibold">${gasInfo.currentGwei?.toFixed(1) || '--'} Gwei</div>
            </div>
            <div class="flex justify-between items-center">
                <div class="text-red-200 text-xs">Network</div>
                <div class="text-white font-semibold">${gasInfo.networkCongestion || '--'}</div>
            </div>
            <div class="flex justify-between items-center">
                <div class="text-red-200 text-xs">ETH Price</div>
                <div class="text-white font-semibold">${gasInfo.ethPrice?.toFixed(0) || '--'}</div>
            </div>
        </div>
    `;
}

function updateGasUI(gasData) {
    if (!gasData) return;

    console.log(gasData)
    
    // Update gas calculator
    document.getElementById('currentGasGwei').textContent = `${gasData.currentGasPriceGwei?.toFixed(2) || '--'} Gwei`;
    document.getElementById('cost1000Tx').textContent = `${gasData.costPer1000MicroTxUSD || '--'}`;
    document.getElementById('cost1000Swaps').textContent = `${gasData.costPer1000SwapTxUSD || '--'}`;
    document.getElementById('networkStatus').textContent = gasData.networkCongestion || '--';
    
    // Update status bar
    document.getElementById('gasPrice').textContent = `${gasData.currentGasPriceGwei?.toFixed(1) || '--'} Gwei`;
    document.getElementById('ethPrice').textContent = `${gasData.ethPriceUSD?.toFixed(0) || '--'}`;
}

// Token Manager Modal
function showTokenManager() {
    loadTokenDatabase();
    document.getElementById('tokenModal').classList.remove('hidden');
}

function hideTokenManager() {
    document.getElementById('tokenModal').classList.add('hidden');
}

async function loadTokenDatabase() {
    try {
        const response = await fetch('/api/tokens');
        if (response.ok) {
            const data = await response.json();
            displayTokenDatabase(data);
        }
    } catch (error) {
        document.getElementById('tokenModalContent').innerHTML = `
            <div class="text-red-300">Failed to load token database</div>
        `;
    }
}

function displayTokenDatabase(data) {
    const content = document.getElementById('tokenModalContent');
    
    if (!data.success || !data.tokens.length) {
        content.innerHTML = `
            <div class="text-center py-8">
                <div class="text-gray-400 text-lg mb-4">No tokens in database</div>
                <div class="text-gray-500">Add some tokens using the token management section</div>
            </div>
        `;
        return;
    }
    
    content.innerHTML = `
        <div class="space-y-4">
            <div class="text-white font-medium">Found ${data.totalTokens} tokens (${data.uniqueSymbols} unique symbols)</div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-80 overflow-y-auto">
                ${data.tokens.map(token => `
                    <div class="bg-white/10 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <div class="text-white font-medium">${token.symbol}</div>
                            <div class="text-gray-400 text-xs">${token.decimals} decimals</div>
                        </div>
                        <div class="text-gray-300 text-sm mb-2">${token.name || 'Unknown Name'}</div>
                        <div class="text-gray-400 text-xs font-mono break-all">${token.address}</div>
                        <div class="text-gray-500 text-xs mt-2">Added ${new Date(token.addedAt).toLocaleDateString()}</div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

// Command execution functions
async function executeCommand(command, args = [], buttonElement = null) {
    const fullCommand = `${command} ${args.join(' ')}`.trim();
    
    logToTerminal(`üöÄ Executing: ${fullCommand}`, 'info');
    addToHistory(fullCommand);
    
    if (buttonElement) {
        buttonElement.disabled = true;
        buttonElement.classList.add('opacity-50');
    }
    
    try {
        const response = await fetch('/api/execute', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ command: command, args: args })
        });
        
        const result = await response.json();
        
        if (result.processId) {
            activeCommands.add(result.processId);
        }
        
        if (!result.success) {
            logToTerminal(`‚ùå Command failed: ${result.error}`, 'error');
            if (result.validationErrors) {
                result.validationErrors.forEach(error => {
                    logToTerminal(`   ‚Ä¢ ${error}`, 'warning');
                });
            }
            stats.failedOps++;
            updateStats();
        }
        
        if (['volumeV2', 'volumeV3', 'volumeV3Fresh', 'create-and-swap', 'create-and-swapv3', 'create-and-multiswapv3'].includes(command)) {
            automationProcesses.add(result.processId || command);
            logToTerminal(`üìä Added to automation tracking: ${command}`, 'info');
        }
        
    } catch (error) {
        logToTerminal(`üåê Network error: ${error.message}`, 'error');
        stats.failedOps++;
        updateStats();
    } finally {
        if (buttonElement) {
            setTimeout(() => {
                buttonElement.disabled = false;
                buttonElement.classList.remove('opacity-50');
            }, 2000);
        }
    }
}

// Wallet management functions
async function createWallets() {
    const count = document.getElementById('createCount').value || '100';
    await executeCommand('create', [count], event.target);
}

async function targetWallets() {
    const target = document.getElementById('targetCount').value;
    if (!target) {
        logToTerminal('Please enter target wallet count', 'warning');
        return;
    }
    await executeCommand('target', [target], event.target);
}

async function checkWallets() {
    await executeCommand('check', [], event.target);
}

// Trading functions
async function startSwapBatch() {
    const batchSize = document.getElementById('tradeBatchSize').value || '50';
    const token = document.getElementById('singleToken').value;
    const delay = '1000';
    
    const args = [batchSize];
    if (token) args.push(token);
    args.push(delay);
    
    await executeCommand('swap-batch', args, event.target);
}

async function startV3SwapBatch() {
    const batchSize = document.getElementById('tradeBatchSize').value || '50';
    const token = document.getElementById('singleToken').value;
    const start = document.getElementById('startIndex').value || '0';
    const end = document.getElementById('endIndex').value || '100';
    const delay = '2000';
    
    await executeCommand('swapv3-batch', [batchSize, token, start, end, delay], event.target);
}

// Volume generation functions
async function startVolumeV2() {
    const start = document.getElementById('startIndex').value || '0';
    const end = document.getElementById('endIndex').value || '100';
    const token = document.getElementById('volumeToken').value;
    const txDelay = document.getElementById('volumeTxDelay').value || '150';
    const cycleDelay = document.getElementById('volumeCycleDelay').value || '3000';
    
    const args = [start, end];
    if (token) args.push(token);
    args.push(txDelay, cycleDelay, '1000');
    
    logToTerminal('üî• Starting V2 volume generation...', 'warning');
    await executeCommand('volumeV2', args, event.target);
}

async function startVolumeV3() {
    const start = document.getElementById('startIndex').value || '0';
    const end = document.getElementById('endIndex').value || '100';
    const token = document.getElementById('volumeToken').value;
    const txDelay = document.getElementById('volumeTxDelay').value || '150';
    const cycleDelay = document.getElementById('volumeCycleDelay').value || '3000';
    
    const args = [start, end];
    if (token) args.push(token);
    args.push(txDelay, cycleDelay, '1000');
    
    logToTerminal('‚ö° Starting V3 volume generation...', 'warning');
    await executeCommand('volumeV3', args, event.target);
}

async function startVolumeV3Fresh() {
    const token = document.getElementById('volumeToken').value;
    const txDelay = document.getElementById('volumeTxDelay').value || '2000';
    const cycleDelay = document.getElementById('volumeCycleDelay').value || '5000';
    const funding = document.getElementById('fundingAmount').value || '0.00001';
    
    const args = [];
    if (token) args.push(token);
    args.push(txDelay, cycleDelay, funding);
    
    logToTerminal('üÜï Starting V3 fresh wallet volume generation...', 'warning');
    await executeCommand('volumeV3Fresh', args, event.target);
}

// Emergency functions
async function killAllProcesses() {
    const button = event.target;
    
    logToTerminal('üö® EMERGENCY: Killing all processes...', 'error');
    button.disabled = true;
    button.innerHTML = 'üíÄ KILLING...';
    
    try {
        const response = await fetch('/api/force-kill', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        if (response.ok) {
            logToTerminal('üíÄ Force kill signal sent', 'warning');
            automationProcesses.clear();
            activeCommands.clear();
            document.getElementById('activeOps').textContent = '0';
            logToTerminal('üõë All processes terminated', 'success');
        }
        
    } catch (error) {
        logToTerminal(`üåê Error during kill operation: ${error.message}`, 'error');
    } finally {
        setTimeout(() => {
            button.disabled = false;
            button.innerHTML = 'üíÄ KILL ALL PROCESSES';
        }, 3000);
    }
}

// Utility functions
function updateConnectionStatus(connected = false) {
    const statusDot = document.getElementById('connectionStatus');
    const statusText = document.getElementById('connectionText');
    
    if (connected) {
        statusDot.className = 'w-3 h-3 rounded-full bg-green-500 animate-pulse-slow';
        statusText.textContent = 'Connected';
    } else {
        statusDot.className = 'w-3 h-3 rounded-full bg-red-500 animate-pulse-slow';
        statusText.textContent = 'Disconnected';
    }
}

function showLoading(show = true) {
    const loading = document.getElementById('loading');
    if (show) {
        loading.classList.remove('hidden');
    } else {
        loading.classList.add('hidden');
    }
}

function logToTerminal(message, type = 'info') {
    const terminal = document.getElementById('terminal');
    const logEntry = document.createElement('div');
    logEntry.className = `log-entry log-${type}`;
    
    const timestamp = new Date().toLocaleTimeString();
    logEntry.innerHTML = `[${timestamp}] ${message}`;
    console.log(message)
    
    terminal.appendChild(logEntry);
    terminal.scrollTop = terminal.scrollHeight;
    
    // Keep only last 1000 entries
    while (terminal.children.length > 1000) {
        terminal.removeChild(terminal.firstChild);
    }
}

function clearTerminal() {
    const terminal = document.getElementById('terminal');
    terminal.innerHTML = `
        <div class="log-entry log-info">Terminal cleared - TurboBot Web Controller v3.0</div>
        <div class="log-entry">Enhanced with real-time API integration</div>
        <div class="log-entry">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</div>
    `;
}

function exportLogs() {
    const terminal = document.getElementById('terminal');
    const logs = Array.from(terminal.children).map(entry => entry.textContent).join('\n');
    
    const blob = new Blob([logs], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `turbobot-logs-${new Date().toISOString().slice(0, 19)}.txt`;
    a.click();
    URL.revokeObjectURL(url);
    
    logToTerminal('üì• Logs exported successfully', 'success');
}

function addToHistory(command) {
    commandHistory.unshift(command);
    if (commandHistory.length > 50) {
        commandHistory.pop();
    }
}

function updateStats() {
    document.getElementById('successfulOps').textContent = stats.successfulOps;
    document.getElementById('failedOps').textContent = stats.failedOps;
    document.getElementById('totalGasUsed').textContent = stats.totalGasUsed.toFixed(6);
    
    const total = stats.successfulOps + stats.failedOps;
    const rate = total > 0 ? ((stats.successfulOps / total) * 100).toFixed(1) : 0;
    document.getElementById('successRate').textContent = `${rate}%`;
}

function parseOutputForStats(output) {
    try {
        if (output.match(/‚úÖ|‚úì|SUCCESS|successful/i) && output.match(/transaction|tx|swap/i)) {
            stats.successfulOps++;
            updateStats();
        }
        
        if (output.match(/‚ùå|‚úó|FAILED|ERROR|failed/i) && output.match(/transaction|tx|swap/i)) {
            stats.failedOps++;
            updateStats();
        }
        
        let gasMatch = output.match(/Gas\s+used:\s*([\d.]+)\s*ETH/i);
        if (gasMatch) {
            const gasUsed = parseFloat(gasMatch[1]);
            stats.totalGasUsed += gasUsed;
            updateStats();
        }
    } catch (error) {
        console.log('Error parsing output for stats:', error);
    }
}

// Refresh functions
async function refreshAllStats() {
    logToTerminal('üîÑ Refreshing all statistics...', 'info');
    showLoading(true);
    
    try {
        await Promise.all([
            loadDashboardData(),
            refreshGasData(),
            loadTokenData()
        ]);
        logToTerminal('‚úÖ All statistics refreshed', 'success');
    } catch (error) {
        logToTerminal(`‚ùå Error refreshing stats: ${error.message}`, 'error');
    } finally {
        showLoading(false);
    }
}

function updateDashboard() {
    loadDashboardData();
}

function updateGasData() {
    refreshGasData();
}

async function viewTokenDatabase() {
    showTokenManager();
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', initializeApp);

// window.addEventListener('load', initializeApp);


// Handle page unload
window.addEventListener('beforeunload', function(e) {
    if (automationProcesses.size > 0) {
        fetch('/api/stop-all', { 
            method: 'POST',
            keepalive: true 
        }).catch(err => console.log('Could not stop automation on page unload'));
        
        e.preventDefault();
        e.returnValue = 'You have running automation processes. Are you sure you want to leave?';
        return e.returnValue;
    }
});

// Auto-refresh connection check
setInterval(() => {
    if (wsConnection && wsConnection.readyState === WebSocket.OPEN) {
        try {
            wsConnection.send(JSON.stringify({ type: 'ping' }));
        } catch (error) {
            initializeWebSocket();
        }
    } else {
        initializeWebSocket();
    }
}, 30000);
    </script>
</body>
</html>